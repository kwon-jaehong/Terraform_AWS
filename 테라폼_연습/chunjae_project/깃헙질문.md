
----------------------------------

귀하의 요청에 대해 알려주십시오
카펜터에서 "aws.amazon.com/neuroncore"를 스케쥴링 할 수 있는 방법이 있습니까?

----------------------------------
해결하려는 문제에 대해 알려주십시오. 당신은 무엇을 하려고 하며, 왜 어렵습니까?
나는 EKS환경에서 ML모델 MSA환경을 구성하려 합니다.
또한 AWS inf1 인스턴스를 사용해 서비스를 운영하려고 한다.

각 서비스는 "aws.amazon.com/neuroncore" 하나씩 사용해서 pod를 구성하였습니다.


https://karpenter.sh/v0.20.0/concepts/instance-types/ 
참조해보면 카펜터에서 inf1 인스턴스 패밀리에서 "neuroncore" 리소스가 없다



[소스 코드 참조]

apiVersion: apps/v1
kind: Deployment
metadata:
  name: example-app
  namespace: default
spec:
  replicas: 10
  selector:
    matchLabels:
      app: example-app
  template:
    metadata:
      labels:
        app: example-app
    spec:
      containers:
      - name: example-app
        image: image:0.1        
        resources:
          limits:
            cpu: 1000m
            memory: 1.5Gi
            aws.amazon.com/neuroncore: 1
          requests:
            cpu: 800m
            memory: 1.0Gi
---
apiVersion: karpenter.sh/v1alpha5
kind: Provisioner
metadata:
  name: default
spec:
  ttlSecondsAfterEmpty: 100
  ttlSecondsUntilExpired: 6000
  limits:
    resources:
      cpu: 1000
      aws.amazon.com/neuron: 100
  requirements:
    - key: "karpenter.sh/capacity-type"
      operator: In
      values: ["on-demand"]
    - key: karpenter.k8s.aws/instance-family
      operator: In
      values: [inf1]
    - key: karpenter.k8s.aws/instance-size
      operator: In
      values: [xlarge, 2xlarge]
  providerRef:
    name: my-provider
---
apiVersion: karpenter.k8s.aws/v1alpha1
kind: AWSNodeTemplate
metadata:
  name: my-provider
spec:
  subnetSelector:
    kubernetes.io/cluster/demo: owned
  securityGroupSelector:
    kubernetes.io/cluster/demo: owned



다음과 같은 오류를 발생시킵니다.
│ controller 2023-03-07T07:48:40.081Z    ERROR    controller.provisioning    Could not schedule pod, incompatible with provisioner "default", no instance type satisfied resources {"aws.amazon.com/neuroncore":"1","cpu":" │
│ 800m","memory":"1Gi","pods":"1"} and requirements karpenter.sh/capacity-type In [on-demand], karpenter.k8s.aws/instance-family In [inf1], karpenter.k8s.aws/instance-size In [2xlarge xlarge], kubernetes.io/arch In │
│  [amd64], karpenter.sh/provisioner-name In [default]    {"commit": "5d4ae35-dirty", "pod": "app/example-app-866f9cb8dd-xqqjj"}  


같은환경에서 뉴런 코어를 쓰면 정상 스케쥴링되어 스팟인스턴스를 추가해 줍니다.
잘되는 소스코드
뉴런 코어를 사용하면, 카펜터가 정상적으로 인스턴스를 생성합니다 작동합니다.



https://karpenter.sh/v0.20.0/concepts/instance-types/ 
참조해보면 카펜터에서 inf1 인스턴스 패밀리에서 "neuroncore"에 대한 리소스가 명시되어 있지 않다.


혹시 카펜터에서 뉴런 코어를 스케쥴링할 수 있는 다른 방법이 있습니까?

---------
현재 이 문제를 해결하고 있습니까?
일단은, pod 리소스 요청을 "aws.amazon.com/neuron"로 사용하려 하지만, 작은 ML모델에서 1개의 뉴런칩(뉴런 코어 4개)를 쓰는것은 매우 비효율적이고, 자원낭비라고 생각합니다.






제목 :  karpenter에서 "aws.amazon.com/neuroncore"에 대한 스케쥴링 지원가능 한가요?
Is it possible to support scheduling for "aws.amazon.com/neuroncore" in karpenter?

------------------------
귀하의 요청에 대해 알려주십시오
Is there any way to schedule "aws.amazon.com/neuroncore" in karpenter?

---------------
해결하려는 문제에 대해 알려주십시오. 당신은 무엇을 하려고 하며, 왜 어렵습니까?
I am trying to configure ML model MSA in EKS environment.
In addition, we plan to operate the service using the AWS 'inf1' instance.
Each service configured a pod using one "aws.amazon.com/neuroncore".

Example code is below.



apiVersion: apps/v1
kind: Deployment
metadata:
  name: example-app
  namespace: default
spec:
  replicas: 10
  selector:
    matchLabels:
      app: example-app
  template:
    metadata:
      labels:
        app: example-app
    spec:
      containers:
      - name: example-app
        image: image:0.1        
        resources:
          limits:
            cpu: 1000m
            memory: 1500Mi
            aws.amazon.com/neuroncore: 1
          requests:
            cpu: 800m
            memory: 1000Mi
---
apiVersion: karpenter.sh/v1alpha5
kind: Provisioner
metadata:
  name: default
spec:
  ttlSecondsAfterEmpty: 100
  ttlSecondsUntilExpired: 6000
  limits:
    resources:
      cpu: 100
      aws.amazon.com/neuron: 100
  requirements:
    - key: "karpenter.sh/capacity-type"
      operator: In
      values: ["on-demand"]
    - key: karpenter.k8s.aws/instance-family
      operator: In
      values: [inf1]
    - key: karpenter.k8s.aws/instance-size
      operator: In
      values: [xlarge, 2xlarge]
  providerRef:
    name: my-provider
---
apiVersion: karpenter.k8s.aws/v1alpha1
kind: AWSNodeTemplate
metadata:
  name: my-provider
spec:
  subnetSelector:
    kubernetes.io/cluster/demo: owned
  securityGroupSelector:
    kubernetes.io/cluster/demo: owned


When I apply the code, it outputs the following error.

karpenter pod error message:

controller 2023-03-07T07:48:40.081Z    ERROR    controller.provisioning    Could not schedule pod, incompatible with provisioner "default", no instance type satisfied resources {"aws.amazon.com/neuroncore":"1","cpu":"800m","memory":"1Gi","pods":"1"} and requirements karpenter.sh/capacity-type In [on-demand], karpenter.k8s.aws/instance-family In [inf1], karpenter.k8s.aws/instance-size In [2xlarge xlarge], kubernetes.io/arch In [amd64], karpenter.sh/provisioner-name In [default]    {"commit": "5d4ae35-dirty", "pod": "app/example-app-866f9cb8dd-xqqjj"}  




But if I set the resource request of "Deployment" to "aws.amazon.com/neuron" as follows, it works fine.

apiVersion: apps/v1
kind: Deployment
            .
            .
            .
            aws.amazon.com/neuron: 1
            .
            .
            .


https://karpenter.sh/v0.20.0/concepts/instance-types/ 
From the karpenter documentation there is no resource "aws.amazon.com/neuroncore" in the inf1 instance family

Is there any other way to schedule "aws.amazon.com/neuroncore" in karpenter?


---------
현재 이 문제를 해결하고 있습니까?
Temporarily, we want to use the pod resource request as "aws.amazon.com/neuron".
However, I think that using one neuron chip (four neuron cores) in a small ML model is inefficient and a waste of resources.



-----------------------------------
I am trying to configure ML model MSA in EKS environment.
In addition, we plan to operate the service using the AWS 'inf1' instance.
Each service configured a pod using one **"aws.amazon.com/neuroncore"**.

Example code.

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: example-app
  namespace: default
spec:
  replicas: 10
  selector:
    matchLabels:
      app: example-app
  template:
    metadata:
      labels:
        app: example-app
    spec:
      containers:
      - name: example-app
        image: image:0.1        
        resources:
          limits:
            cpu: 1000m
            memory: 1500Mi
            aws.amazon.com/neuroncore: 1
          requests:
            cpu: 800m
            memory: 1000Mi
---
apiVersion: karpenter.sh/v1alpha5
kind: Provisioner
metadata:
  name: default
spec:
  ttlSecondsAfterEmpty: 100
  ttlSecondsUntilExpired: 6000
  limits:
    resources:
      cpu: 100
      aws.amazon.com/neuron: 100
  requirements:
    - key: "karpenter.sh/capacity-type"
      operator: In
      values: ["on-demand"]
    - key: karpenter.k8s.aws/instance-family
      operator: In
      values: [inf1]
    - key: karpenter.k8s.aws/instance-size
      operator: In
      values: [xlarge, 2xlarge]
  providerRef:
    name: my-provider
---
apiVersion: karpenter.k8s.aws/v1alpha1
kind: AWSNodeTemplate
metadata:
  name: my-provider
spec:
  subnetSelector:
    kubernetes.io/cluster/demo: owned
  securityGroupSelector:
    kubernetes.io/cluster/demo: owned
```

When I apply the code, it outputs the following error.

karpenter pod error message:
```
controller 2023-03-07T07:48:40.081Z    ERROR    controller.provisioning    Could not schedule pod, incompatible with provisioner "default", no instance type satisfied resources {"aws.amazon.com/neuroncore":"1","cpu":"800m","memory":"1Gi","pods":"1"} and requirements karpenter.sh/capacity-type In [on-demand], karpenter.k8s.aws/instance-family In [inf1], karpenter.k8s.aws/instance-size In [2xlarge xlarge], kubernetes.io/arch In [amd64], karpenter.sh/provisioner-name In [default]    {"commit": "5d4ae35-dirty", "pod": "app/example-app-866f9cb8dd-xqqjj"}  
```   


**But if I set the resource request of "Deployment" to "aws.amazon.com/neuron" as follows, it works fine.**      

```
apiVersion: apps/v1
kind: Deployment
            .
            .
            .
            aws.amazon.com/neuron: 1
            .
            .
            .
```

[From the karpenter documentation ](https://karpenter.sh/v0.20.0/concepts/instance-types/ )there is no resource "aws.amazon.com/neuroncore" in the inf1 instance family.   

Is there any other way to schedule "aws.amazon.com/neuroncore" in karpenter?
